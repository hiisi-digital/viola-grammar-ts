name: Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      dry_run:
        description: "Dry run (validate without publishing)"
        required: false
        default: true
        type: boolean
      prerelease_tag:
        description: "Prerelease tag (e.g. alpha.1, beta.2) — leave empty for stable"
        required: false
        default: ""
        type: string

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest

    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # ── Version calculation ──────────────────────────────────────────

      - name: Calculate new version
        id: version
        run: |
          CURRENT=$(deno eval "console.log(JSON.parse(Deno.readTextFileSync('deno.json')).version)")
          echo "current=$CURRENT" >> $GITHUB_OUTPUT

          IFS='.' read -r MAJOR MINOR PATCH <<< "${CURRENT%%-*}"

          case "${{ inputs.bump }}" in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac

          NEW="${MAJOR}.${MINOR}.${PATCH}"

          PRE="${{ inputs.prerelease_tag }}"
          if [ -n "$PRE" ]; then
            NEW="${NEW}-${PRE}"
          fi

          PKG_NAME=$(deno eval "console.log(JSON.parse(Deno.readTextFileSync('deno.json')).name)")

          echo "new=$NEW" >> $GITHUB_OUTPUT
          echo "tag=v${NEW}" >> $GITHUB_OUTPUT
          echo "name=$PKG_NAME" >> $GITHUB_OUTPUT
          echo "prerelease=$( [ -n \"$PRE\" ] && echo true || echo false )" >> $GITHUB_OUTPUT

          echo "## Version" >> $GITHUB_STEP_SUMMARY
          echo "- Current: \`$CURRENT\`" >> $GITHUB_STEP_SUMMARY
          echo "- New: \`$NEW\` (\`${{ inputs.bump }}\`)" >> $GITHUB_STEP_SUMMARY
          echo "- Tag: \`v${NEW}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Dry run: \`${{ inputs.dry_run }}\`" >> $GITHUB_STEP_SUMMARY

      - name: Update deno.json version
        run: |
          deno eval '
            const config = JSON.parse(Deno.readTextFileSync("deno.json"));
            config.version = "${{ steps.version.outputs.new }}";
            Deno.writeTextFileSync("deno.json", JSON.stringify(config, null, 2) + "\n");
          '
          echo "Updated deno.json to ${{ steps.version.outputs.new }}"
          cat deno.json

      # ── Validation ───────────────────────────────────────────────────

      - name: Type check
        run: deno check mod.ts

      - name: Run tests
        run: deno test --allow-all src/ tests/

      - name: Validate publish config
        run: |
          deno eval '
            const c = JSON.parse(Deno.readTextFileSync("deno.json"));
            const required = ["name", "version", "exports"];
            for (const key of required) {
              if (!c[key]) { console.error("Missing " + key); Deno.exit(1); }
            }
            console.log(c.name + "@" + c.version + " — config valid");
          '

      - name: Dry-run publish
        run: deno publish --dry-run --allow-dirty --allow-slow-types

      # ── Release (skipped in dry run) ─────────────────────────────────

      - name: Commit version bump
        if: inputs.dry_run == false
        run: |
          git add deno.json
          git commit -m "release: v${{ steps.version.outputs.new }}"

      - name: Create and push tag
        if: inputs.dry_run == false
        run: |
          git tag "v${{ steps.version.outputs.new }}"
          git push origin main --tags

      - name: Publish to JSR
        if: inputs.dry_run == false
        run: deno publish --allow-dirty --allow-slow-types

      - name: Generate changelog
        if: inputs.dry_run == false
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          TAG="v${{ steps.version.outputs.new }}"
          FILE=$(mktemp)

          echo "## What's Changed" > "$FILE"
          echo "" >> "$FILE"

          if [ -n "$PREV_TAG" ]; then
            git log --pretty=format:"- %s (%h)" "$PREV_TAG".."$TAG" >> "$FILE" || true
            COMPARE="${PREV_TAG}...${TAG}"
          else
            git log --pretty=format:"- %s (%h)" >> "$FILE" || true
            COMPARE="$(git rev-list --max-parents=0 HEAD)...${TAG}"
          fi

          echo "" >> "$FILE"
          echo "" >> "$FILE"
          echo "## Install" >> "$FILE"
          echo "" >> "$FILE"
          echo '```bash' >> "$FILE"
          echo "deno add jsr:${{ steps.version.outputs.name }}" >> "$FILE"
          echo '```' >> "$FILE"
          echo "" >> "$FILE"
          echo '```ts' >> "$FILE"
          echo "import typescript from \"${{ steps.version.outputs.name }}\";" >> "$FILE"
          echo '```' >> "$FILE"
          echo "" >> "$FILE"
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${COMPARE}" >> "$FILE"

          echo "file=$FILE" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        if: inputs.dry_run == false
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.new }}
          name: v${{ steps.version.outputs.new }}
          body_path: ${{ steps.changelog.outputs.file }}
          draft: false
          prerelease: ${{ steps.version.outputs.prerelease }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ── Summary ──────────────────────────────────────────────────────

      - name: Summary
        if: inputs.dry_run == false
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Released" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Package**: [${{ steps.version.outputs.name }}@${{ steps.version.outputs.new }}](https://jsr.io/${{ steps.version.outputs.name }}@${{ steps.version.outputs.new }})" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHub Release**: [v${{ steps.version.outputs.new }}](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.new }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "deno add jsr:${{ steps.version.outputs.name }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Dry-run summary
        if: inputs.dry_run == true
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Dry Run Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All checks passed. Run again with **dry_run: false** to publish." >> $GITHUB_STEP_SUMMARY
